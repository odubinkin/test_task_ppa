# Спецификация разработки

## 1. Цель
Реализовать мини-приложение на Next.js 16 для отображения списка объектов недвижимости с переключением валюты и корректным SSR-рендерингом выбранной валюты без визуального мерцания.

## 2. Технологии и обязательные ограничения
- Next.js 16 (App Router)
- TypeScript в strict mode
- React
- Tailwind CSS
- Shadcn UI
- Код (имена переменных, функций, компонентов, комментарии): на английском языке
- Тексты интерфейса: на русском языке

## 3. Источник данных
Данные объектов недвижимости хранятся в `data.json` как массив объектов.

Базовая структура элемента:

```json
{
  "name": "Название объекта недвижимости",
  "description": "Краткое описание",
  "price": 1000000,
  "area": 52,
  "tags": ["near beach", "investment"],
  "image": "villa-1.jpg",
  "contacts": {
    "telegram": "https://t.me/example",
    "whatsapp": "https://wa.me/....",
    "line": "https://line.me/....",
    "phone": "+66...",
    "email": "example@mail.com"
  }
}
```

Примечания:
- Поле `price` хранится в THB.
- Количество объектов: 5–10.
- Изображения физически хранятся в `public/pictures`.
- Поле `contacts` может содержать только часть каналов (все поля внутри `contacts` опциональны).

Курсы валют хранятся в `exchange_rates.json`.

Базовая структура:

```json
{
  "THB": 1,
  "USD": 0.0286,
  "EUR": 0.0263,
  "RUB": 2.57
}
```

Примечания:
- Значения интерпретируются как коэффициенты перевода из THB.
- Обязательные ключи: `THB`, `USD`, `EUR`, `RUB`.

## 4. Функциональные требования

### 4.1 Страница списка недвижимости
На странице выводится список карточек недвижимости.

Каждая карточка отображает:
- название объекта
- изображение (из `public/pictures`; при отсутствии — placeholder)
- краткое описание
- цену
- площадь
- список тегов
- доступные контакты

### 4.2 Теги
- Теги выводятся как список бейджей.
- Каждый тег отображается в отдельном бейдже.
- Если список тегов пуст, блок тегов скрывается.

### 4.3 Контакты
- Для каждого доступного контакта рендерится соответствующая кнопка/ссылка.
- Кнопка создается только для реально присутствующего поля в `contacts`.
- Поддерживаемые типы: `telegram`, `whatsapp`, `line`, `phone`, `email`.
- Если контактов нет, блок контактов не выводится.

### 4.4 Переключатель валюты
В header размещается dropdown со значениями:
- THB
- USD
- EUR
- RUB

Требования:
- выбор пользователя сохраняется между сессиями в cookie;
- значение по умолчанию при отсутствии/невалидности cookie: `THB`.

### 4.5 Отображение цены
Компонент цены принимает сумму в THB и выбранную валюту, после чего:
- конвертирует сумму по фиксированным курсам;
- форматирует число и символ валюты через `Intl.NumberFormat`.

Курсы берутся из `exchange_rates.json`.

Формула:

```text
converted = amountInThb * rate[selectedCurrency]
```

## 5. SSR и сохранение состояния
- Выбранная валюта хранится в cookie.
- Серверный рендер читает cookie и сразу отдает страницу с корректной валютой.
- При первом отображении не должно быть расхождения серверной и клиентской версий цены (без flicker/mismatch).
- При смене валюты cookie обновляется, и последующий SSR использует новое значение.

## 6. Архитектурные требования (декомпозиция)
- `CurrencySelector` — UI выбора валюты в header.
- `Price` — изолированная логика конвертации и форматирования цены.
- `PropertyCard` — отображение карточки объекта.
- `Contacts` — отображение набора доступных контактных действий.
- Серверный слой страницы — чтение cookie, загрузка `data.json` и `exchange_rates.json`, SSR списка.

## 7. Нефункциональные требования
- Типобезопасность данных (`type`/`interface` для объекта недвижимости и контактов).
- Простая расширяемость: добавление новых объектов в `data.json` не требует изменения UI-логики.
- Отсутствие запросов к внешним API для получения валютных курсов (используется локальный `exchange_rates.json`).
- Критичная проверяемая логика должна быть вынесена в чистые функции (без побочных эффектов), чтобы обеспечивать простое и надежное unit-тестирование.

## 8. Тестирование
Критичная логика должна быть покрыта тестами.

Минимальный обязательный набор:
- unit: конвертация валют (все 4 валюты + базовый кейс THB)
- unit: форматирование цены для каждой валюты
- unit: валидация/парсинг валюты из cookie (включая fallback на THB)
- component: условный рендер кнопок контактов по наличию данных
- component: рендер тегов (каждый тег отдельным бейджем, пустой список скрывается)

Дополнительно:
- тест на некорректный/пустой `contacts`
- тест на пустой массив тегов

## 9. Критерии приемки
Задача считается выполненной, если:
- страница рендерит 5–10 карточек недвижимости из `data.json`;
- каждая карточка показывает название, изображение, цену, площадь, теги и доступные контакты;
- переключение валюты работает для THB/USD/EUR/RUB;
- курсы валют читаются из `exchange_rates.json`;
- выбор валюты сохраняется в cookie между сессиями;
- SSR отдает цены в выбранной валюте без визуального мерцания;
- критичная логика покрыта тестами, тесты проходят;
- в проекте есть README с инструкцией запуска.

## 10. Явно вне scope
- Реальные API курсов валют
- Бэкенд/БД/админ-панель
- Авторизация пользователей
- Фильтры, сортировка и поиск

## 11. Риски и контроль
Риски:
- рассинхрон SSR/CSR при работе с cookie;
- невалидные или неполные записи в `data.json`;
- ошибки форматирования валют в разных окружениях.

Меры контроля:
- единая утилита чтения/валидации валюты;
- дефолтное значение THB при любых отклонениях;
- тесты на граничные сценарии.
